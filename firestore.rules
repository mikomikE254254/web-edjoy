/**
 * This ruleset enforces a security model for a retail product catalog.
 *
 * Core Philosophy:
 * The primary goal is to allow any user to browse the catalog freely while enabling
 * administrators to manage products during development. Write access is currently
 * open for prototyping purposes and MUST be secured before production.
 *
 * Data Structure:
 * - /products/{productId}: Stores individual product details.
 * - /products/{productId}/reviews/{reviewId}: Stores user-specific ratings.
 * - /categories/{categoryId}: Stores category information.
 * - /styles/{styleId}: Stores style information.
 * - /orders/{orderId}: Stores customer order information.
 * This flat structure is performant and simplifies security rules.
 *
 * Key Security Decisions:
 * - Public Read Access: All documents are publicly readable to allow the app's front-end
 *   to function for all visitors.
 * - Open Write Access (for Prototyping): For development, write operations on products,
 *   categories, and styles are allowed (`if true;`). This is insecure and must be
 *   replaced with role-based access control before launch.
 * - Authenticated Review Writes: Any authenticated user (including anonymous) can
 *   create a review, but cannot edit or delete reviews.
 * - Authenticated Order Management: Any authenticated user can create an order. For now,
 *   all authenticated users can read all orders to facilitate admin dashboard functionality.
 *   This should be restricted in production.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    match /products/{productId} {
      allow read: if true;
      allow write: if true; // WARNING: Open write access for prototyping.

      match /reviews/{reviewId} {
        allow read: if true;
        // Any authenticated user (including anonymous) can create a review.
        // Data must conform to the expected schema.
        // Editing/deleting is not allowed by this rule.
        allow create: if request.auth != null
                      && request.resource.data.userId == request.auth.uid
                      && request.resource.data.userName is string && request.resource.data.userName.size() >= 2 && request.resource.data.userName.size() <= 50
                      && request.resource.data.rating is number && request.resource.data.rating >= 1 && request.resource.data.rating <= 5
                      && request.resource.data.comment is string && request.resource.data.comment.size() >= 10 && request.resource.data.comment.size() <= 500
                      && request.resource.data.createdAt == request.time;
      }
    }

    match /categories/{categoryId} {
      allow read: if true;
      // Allow writes for admin to add new categories during development
      allow write: if true;
    }
    
    match /styles/{styleId} {
      allow read: if true;
      // Allow writes for admin to add new styles during development
      allow write: if true;
    }
    
    match /orders/{orderId} {
      allow read, write: if request.auth != null; // WARNING: Open for prototyping
    }
  }
}
